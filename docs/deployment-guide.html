<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>راهنمای استقرار پروژه my-shop2 (Production)</title>
  <style>
    body { font-family: Vazirmatn, Tahoma, Arial, sans-serif; line-height: 1.7; margin: 2rem; color: #111; }
    h1, h2, h3 { margin: 1.2rem 0 0.6rem; }
    code, pre { font-family: "Cascadia Code", "Fira Code", Consolas, monospace; }
    pre { background: #f6f8fa; padding: 1rem; border-radius: 8px; overflow: auto; border: 1px solid #e5e7eb; }
    .muted { color: #555; }
    ul { padding-inline-start: 1.2rem; }
    .section { margin-bottom: 2rem; }
    @media print {
      body { margin: 0.8in; }
      a[href]::after { content: " (" attr(href) ")"; font-size: 10px; color: #666; }
    }
  </style>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;700&display=swap" rel="stylesheet">
  <meta name="generator" content="auto-export" />
</head>
<body>
  <h1>راهنمای استقرار پروژه my-shop2 (Production)</h1>
  <p class="muted">این سند مراحل کامل دیپلوی نسخه تولیدی پروژه را روی سرور لینوکسی (Ubuntu + Nginx + SSL + PM2 + MongoDB) توضیح می‌دهد.</p>

  <div class="section">
    <h2>معماری</h2>
    <ul>
      <li><strong>Frontend (Next.js 15)</strong>: اجرا روی پورت 3000، دارای <code>rewrites</code> برای ارسال <code>/api</code> به بک‌اند.</li>
      <li><strong>Backend (Express + Mongoose)</strong>: اجرا روی پورت 5000، سرویس‌دهی به مسیرهای <code>/api/*</code> و فایل‌های استاتیک در <code>/uploads</code>.</li>
      <li><strong>Database (MongoDB)</strong>: متصل از طریق <code>MONGO_URI</code>.</li>
    </ul>
  </div>

  <div class="section">
    <h2>متغیرهای محیطی</h2>
    <h3>Frontend (.env.production در ریشه)</h3>
    <pre><code>PORT=3000
NEXT_PUBLIC_API_URL=http://127.0.0.1:5000
# اگر Nginx مسیر /api را پروکسی می‌کند:
# NEXT_PUBLIC_API_URL=https://your-domain.com</code></pre>

    <h3>Backend (shop-backend/.env)</h3>
    <pre><code>NODE_ENV=production
PORT=5000
MONGO_URI=mongodb://127.0.0.1:27017/shop
ALLOWED_ORIGINS=https://your-domain.com
JWT_SECRET=change_me
ENABLE_JOBS=true

# اختیاری
FREE_SHIPPING_THRESHOLD=500000
PUBLIC_BASE_URL=https://your-domain.com
FRONTEND_BASE_URL=https://your-domain.com
ZARINPAL_MERCHANT_ID=xxxx
ZARINPAL_SANDBOX=false
ZARINPAL_SEND_IN_RIAL=true

# SMTP
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=user@example.com
SMTP_PASS=***
SMTP_SECURE=false
MAIL_FROM=Shop &lt;no-reply@example.com&gt;</code></pre>
  </div>

  <div class="section">
    <h2>پیش‌نیازها</h2>
    <ul>
      <li>Ubuntu 22.04/24.04</li>
      <li>Node.js 20 LTS</li>
      <li>PM2</li>
      <li>Nginx</li>
      <li>MongoDB (لوکال یا مدیریت‌شده)</li>
    </ul>
  </div>

  <div class="section">
    <h2>نصب نرم‌افزارها روی سرور</h2>
    <pre><code>sudo apt update && sudo apt upgrade -y
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs build-essential nginx
sudo npm i -g pm2

# MongoDB (اختیاری اگر لوکال)
sudo apt install -y mongodb
sudo systemctl enable --now mongodb</code></pre>
  </div>

  <div class="section">
    <h2>دریافت کد و نصب وابستگی‌ها</h2>
    <pre><code>sudo mkdir -p /var/www/my-shop2 && sudo chown $USER:$USER /var/www/my-shop2
cd /var/www/my-shop2
# git clone &lt;REPO_URL&gt; .  یا انتقال فایل‌ها
npm ci
cd shop-backend &amp;&amp; npm ci &amp;&amp; cd ..</code></pre>
  </div>

  <div class="section">
    <h2>ساخت و اجرای سرویس‌ها با PM2</h2>
    <pre><code>npm run build
pm2 start shop-backend/app.js --name api --env production
pm2 start npm --name web -- start
pm2 save
pm2 startup systemd -u $USER --hp $HOME</code></pre>

    <p>نمونه <code>ecosystem.config.json</code>:</p>
    <pre><code>{
  "apps": [
    { "name": "api", "script": "shop-backend/app.js", "env": { "NODE_ENV": "production" } },
    { "name": "web", "script": "npm", "args": "start", "env": { "PORT": "3000" } }
  ]
}</code></pre>
  </div>

  <div class="section">
    <h2>پیکربندی Nginx</h2>
    <p>گزینه A (همه درخواست‌ها به Next):</p>
    <pre><code>server {
  server_name your-domain.com www.your-domain.com;
  listen 80;
  listen [::]:80;
  location / {
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }
}</code></pre>

    <p>گزینه B (توصیه‌شده: <code>/api</code> به بک‌اند):</p>
    <pre><code>server {
  server_name your-domain.com www.your-domain.com;
  listen 80;
  listen [::]:80;
  location /api/ {
    proxy_pass http://127.0.0.1:5000/api/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
  location /uploads/ {
    proxy_pass http://127.0.0.1:5000/uploads/;
    proxy_set_header Host $host;
  }
  location / {
    proxy_pass http://127.0.0.1:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}</code></pre>

    <p>فعال‌سازی سایت:</p>
    <pre><code>sudo tee /etc/nginx/sites-available/my-shop2 &gt;/dev/null &lt;&lt;'NGINX'
# یکی از کانفیگ‌های بالا را قرار دهید
NGINX
sudo ln -s /etc/nginx/sites-available/my-shop2 /etc/nginx/sites-enabled/
sudo nginx -t &amp;&amp; sudo systemctl reload nginx</code></pre>
  </div>

  <div class="section">
    <h2>SSL با Certbot</h2>
    <pre><code>sudo apt install -y certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com -d www.your-domain.com --redirect --email you@example.com --agree-tos --no-eff-email</code></pre>
  </div>

  <div class="section">
    <h2>نکات امنیت و عملکرد</h2>
    <ul>
      <li><code>ALLOWED_ORIGINS</code> برابر دامنه تولید باشد.</li>
      <li><code>JWT_SECRET</code> قوی و محرمانه باشد.</li>
      <li>مسیر <code>shop-backend/uploads</code> دسترسی نوشتن داشته باشد.</li>
    </ul>
    <pre><code>sudo ufw allow OpenSSH
sudo ufw allow 'Nginx Full'
sudo ufw enable</code></pre>
  </div>

  <div class="section">
    <h2>دیتابیس و Seed</h2>
    <pre><code>mongosh
use shop
db.createUser({ user: "shopuser", pwd: "StrongPass!", roles: ["readWrite"] })
node shop-backend/seed.js</code></pre>
  </div>

  <div class="section">
    <h2>لاگ‌ها و مانیتورینگ</h2>
    <pre><code>pm2 logs api
pm2 logs web
pm2 monit
pm2 install pm2-logrotate
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 7</code></pre>
  </div>

  <div class="section">
    <h2>به‌روزرسانی نسخه</h2>
    <pre><code>git pull
npm ci
cd shop-backend &amp;&amp; npm ci &amp;&amp; cd ..
npm run build
pm2 reload all</code></pre>
  </div>

  <div class="section">
    <h2>تست نهایی</h2>
    <ul>
      <li><code>curl http://127.0.0.1:5000/</code> باید "Shop Backend is running" بدهد.</li>
      <li><code>curl http://127.0.0.1:5000/api/settings</code> پاسخ JSON بدهد.</li>
      <li>مرور <strong>https://your-domain.com</strong> بعد از SSL.</li>
      <li>تست پرداخت زرین‌پال (در صورت پیکربندی).</li>
    </ul>
  </div>

</body>
</html>



